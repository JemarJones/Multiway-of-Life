$(document).ready(function(){function e(e){for(var t=0;t<s.length;t++)if(s[t].id===e)return s[t]}function t(){p.fillStyle="white",p.fillRect(0,0,v,h),p.strokeStyle="#50514f",p.lineWidth=.1
for(var e=0;h>=e;e+=g)p.beginPath(),p.moveTo(0,e),p.lineTo(v,e),p.stroke(),p.closePath()
for(var t=0;v>=t;t+=g)p.beginPath(),p.moveTo(t,0),p.lineTo(t,h),p.stroke(),p.closePath()
L||C||(p.strokeStyle="#50514f",p.lineWidth=.5,p.beginPath(),p.moveTo(v/2,0),p.lineTo(v/2,h),p.stroke(),p.closePath())}function o(){for(var t=0;t<c.length;t++)for(var o=0;o<c[0].length;o++)0!==c[t][o]&&(p.fillStyle=e(c[t][o]).colour,p.fillRect(t*g,o*g,g,g))}function n(){p.clearRect(0,0,v,h),t(),o()}function l(e){b=!0
var t=m.getBoundingClientRect()
w.x=Math.floor((e.clientX-t.left)/g),w.y=Math.floor((e.clientY-t.top)/g),0!==c[w.x][w.y]?w.erase=!0:w.erase=!1}function a(e){i(e,!1),b=!1}function r(e){b&&i(e,!0)}function i(e,t){var o=m.getBoundingClientRect(),l={x:0,y:0}
l.x=e.clientX-o.left,l.y=e.clientY-o.top,0<=l.y&&l.y<=h&&0<=l.x&&!k&&(l.x<=v/B&&"left"===f||l.x>v/B&&"right"===f)&&(l.x=Math.floor(l.x/g),l.y=Math.floor(l.y/g),l.x==w.x&&l.y==w.y&&t||(0!==c[l.x][l.y]&&w.erase?(C||cellsLeft++,c[l.x][l.y]=0):0==c[l.x][l.y]&&cellsLeft>0&&!w.erase&&(C||cellsLeft--,c[l.x][l.y]=u),C||$(".numCellsLeft").text(cellsLeft),n(),w.x=l.x,w.y=l.y))}var c,s,u,f,d,y=io(),m=document.getElementById("lifecanvas"),p=m.getContext("2d"),v=m.width,h=m.height,g=10,x="#1a5d7a",k=!1,L=!1,w={x:0,y:0,erase:!1},b=!1,B=2,C=!1
$(".colourBlock").on("click",function(){$(".colourBlock").removeClass("chosenBlock"),$(this).addClass("chosenBlock"),$(".landing").focus(),x=$(this).css("background-color")})
var R=function(){if(void 0!==x){var e=$("#playerNameInput").val().replace(/\s+/g,"")
""!==e&&(player={username:e,colour:x},y.emit("joinRoom",player),$(".landing").hide(),$(".game").show(),t())}}
$(".join").on("mousedown",R),$(document).keydown(function(e){if(13==e.keyCode&&R(),9==e.keyCode){e.preventDefault()
for(var t=0;t<$(".colourBlock").length;t++)if($(".chosenBlock")[0]===$(".colourBlock")[t]){$($(".colourBlock")[(t+1)%$(".colourBlock").length]).click()
break}}}),y.on("roomJoined",function(t){u=t.id,s=t.species,cellsLeft=e(u).cellsLeft,c=t.world,f=e(u).side,$(".numCellsLeft").text(cellsLeft),$(".playerName"+f).text(e(u).username),$(".canvContainer").append('<div class="oponentOverlay"><span class="waitingLabel">Waiting for an oponent..</span></div>')
var o="left"==f?"right":"left"
if($(".oponentOverlay").css(o,"0"),s.length>1){var l=s[0]
d=l.username,$(".playerName"+l.side).text(l.username),l.readyToPlay===!1?$(".waitingLabel").text(l.username+" is birthing cells.."):$(".waitingLabel").text(l.username+" is ready!")}$("."+f+"Col").append('<input class="button-primary ready" value="Ready" type="submit">'),1===s.length&&$("."+f+"Col").append('<input class="button-primary practice" value="Practice" type="submit">'),$(".ready").on("mousedown",function(){k||(y.emit("readyToPlay",{world:c}),y.on("readyRequestAcepted",function(){$(".ready").remove(),$(".cellsLeft").remove(),$(".practice").remove(),k=!0}),y.on("readyRequestRejected",function(e){swal({title:"Request failed.",text:e.message,type:"error",confirmButtonText:"Ok."})}))}),$(".practice").click(function(){y.emit("requestPractice"),y.on("practiceStarted",function(){B=1,C=!0,$(".practice").remove(),$(".cellsLeft").remove(),$(".oponentOverlay").remove(),$(".playerName"+("left"==f?"right":"left")).text(" "),n()})})}),y.on("newSpeciesJoined",function(e){s=e.species
var t=s[1]
d=t.username,$(".practice").remove(),$(".playerName"+t.side).text(t.username),$(".waitingLabel").text(t.username+" is birthing cells..")}),y.on("otherPlayerReady",function(){$(".waitingLabel").text(d+" is ready!")}),y.on("worldUpdated",function(e){$(".oponentOverlay").remove(),L=!0,c=e.world,n()}),m.addEventListener("mousedown",l,!1),m.addEventListener("mousemove",r,!1),m.addEventListener("mouseup",a,!1)})
